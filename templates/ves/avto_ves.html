{% extends 'base.html' %}
{#{% load static %}#}
{% block title %}
    Автотранспорт
{% endblock %}
{% block content %}

    <div id="body" class="container-fluid" style="text-align: center;">
        <input type="checkbox" id="hmt" class="hidden-menu-ticker">

        <label class="btn-menu" for="hmt">
            авто
        </label>
        <div class="hidden-menu" style="overflow: auto;">

            <div class="accordion" id="accordionExample">
                {% for a in auto_in %}
                    <div class="card">
                        <div class="card-header" id="headingOne_{{ a.id }}">
                            <h2 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse"
                                        data-target="#collapseOne_{{ a.id }}"
                                        aria-expanded="true" aria-controls="collapseOne_{{ a.id }}">
                                    {{ a.number }}
                                </button>
                            </h2>
                        </div>

                        <div id="collapseOne_{{ a.id }}" class="collapse" aria-labelledby="headingOne_{{ a.id }}"
                             data-parent="#accordionExample">
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th scope="col">агент</th>
                                        <th scope="col">накладная</th>
                                        <th scope="col">время</th>
                                        <th scope="col">масса, кг</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>{{ a.agents.name }}</td>
                                        <td>{{ a.nakladnaya }}</td>
                                        <td>{{ a.last_in }}</td>
                                        <td>{{ a.ves_in }}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endfor %}


            </div>


        </div>

{% include  'ves/ves_row.html' %}




{% include 'ves/nakladnaya_row.html' %}
    </div>



<hr>
        </div>
{% include 'ves/cam_row.html' %}
    </div>


    <!-- Modal change GosNomAvto -->
    <div class="modal fade" id="gosnomeravto" tabindex="-1" role="dialog" aria-labelledby="gosnomeravto"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gosnomeravto">Изменить номер авто</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group col-md-7">
                        <label for="gosNavto">Номер авто</label>
                        <input type="text" class="form-control" id="gosNavto"
                               pattern="([0-9][0-9][0-9][0-9])" maxlength='4' name="gosNavto"
                        >
                    </div>
                    <div class="form-group col-md-3">
                        <label for="seriaAvto">Серия </label>
                        <input type="text" class="form-control" id="seriaAvto" maxlength="2"
                               pattern="([a-zA-Z][a-zA-Z])" name="seriaAvto">
                    </div>
                    <div class="form-group col-md-2 ">
                        <label for="regionAvto">Регион</label>
                        <input type="text" class="form-control" pattern="([0-7])"
                               id="regionAvto" maxlength="1" name="regionAvto">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">отмена</button>
                    <button type="button" onclick="changeNumAvto()" class="btn btn-primary">Изменить</button>
                </div>
            </div>
        </div>
    </div>



    {% csrf_token %}







    <script>
        // using jQuery
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
        var pricep = false;
        var count = 1;
        var rowsTable = [];
        var Table = [];


        let agents = "{{ agentsJ }}";
agents = agents.replace(/&quot;/g,'"');
agents = JSON.parse(agents);
let newAgents =[];
    agents.forEach(function(a){
        newAgents.push(a.fields);
    });
        var filterInt = function (value) {
            if (/^(\-|\+)?([0-9]+|Infinity)$/.test(value))
                return Number(value);
            return false;
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function addAction(action) {
            let data = "where=auto&action=" + action + "&user={{ request.user.id }}";
            $.ajax({
                type: "POST",
                url: '{% url 'addaction' %}',
                data: data,
                success: function () {
                    console.log('Load was performed.');
                },
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
        }

        function addNakladnayaRow() {
            let typeCar = $("[name='cheks']:checked").val();
            if (typeCar == 2) {
                alert('Транспорт порожний');
                return;
            }
            let valuta = $("#valuta").val();
            let price = $('#price').val();
            let ed = $("#ed").val();
            let ves_nakladnay = $("#ves_nakladnaia").val();
            let nakladnay = $("#nakladnaya").val();
            let name = $("#nameGruz").val();
            if (!name) {
                addAction('оператор добавляя запись в список не указал название ');
                alert("Вы не указали название товара.");
                $("#nameGruz").focus();
                return;
            }
            if (!price) {
                addAction('оператор добавляя запись в список не указал цену ');
                alert('Вы не указали цену товара');
                $("#price").focus();
                return;
            }
            if (!price.match(/^(0$|-?[1-9]\d*(\.\d*[1-9]$)?|-?0\.\d*[1-9])$/)) {
                alert("В поле цена должны быть введены только цифры");
                $("#price").focus();
                return;
            }
            if (!ves_nakladnay) {
                addAction('оператор добавляя запись в список не указал вес по накладной ');
                if (!confirm('Вы не уакзали вес по надклдной. Продолжить?')) {
                    return;
                }
            }
            if (!ves_nakladnay.match(/^(0$|-?[1-9]\d*(\.\d*[1-9]$)?|-?0\.\d*[1-9])$/)) {
                alert("В поле вес должны быть введены только цифры");
                $("#ves_nakladnaia").focus();
                return;
            }
            addAction('оператор добавил запись в список накладной');
            Table[count] = {
                "count": count,
                "name": name,
                "ves": ves_nakladnay,
                "ed": ed,
                "price": price,
                "valuta": valuta
            };
            let row = "<tr><td>" + count + "</td><td>" + name + "</td><td>" + ves_nakladnay + " ," + ed + "</td><td>" + price + " ," + valuta + "</td><td><button id='row_" + count + "' onclick='deleteRow(this)'>x</button></td>";
            let table = $("#table-nakladnaya").html();
            rowsTable[count] = row;
            let newtable = rowsTable.join("");
            $("#table-nakladnaya").html(newtable);
            count++;
        }

        function deleteRow(e) {
            addAction('оператор удалил запись из списка накладной');
            let ar = e.id.split('_');
            rowsTable = [];
            delete Table[ar[1]];
            console.log(Table);
            var newTable = [];
            var c = 1;
            Table.forEach(function (a, v) {
                a.count = c;
                rowsTable[c] = "<tr><td>" + a.count + "</td><td>" + a.name + "</td><td>" + a.ves_nakladnay + " ," + a.ed + "</td><td>" + a.price + " ," + a.valuta + "</td><td><button id='row_" + a.count + "' onclick='deleteRow(this)'>x</button></td>";
                ;
                c++;
            });


            let newtable = rowsTable.join("");
            $("#table-nakladnaya").html(newtable);
            count--;
        }

let status1=false;
        function addAuto() {
            let numberPricep = $("#gos_num_pricep").html();
            var num = $('#gos_num_avto').html();
            var arrAuto = num.split('-');
            var arrPricep = num.split('-');
            let numAuto = arrAuto.join("");
            let nunu= numAuto;
            let numPricep = arrPricep.join("");
            let prov =parseInt(nunu);
            if(!prov  || prov==0){
                alert('ошибка с номером автотранспорта');
                 return;
            }
            let agent;
            let ves = $("#vesFix").html();
            let ves_nakladnay = $("#ves_nakladnaia").val();
            let nakladnay = $("#nakladnaya").val();
            if (!nakladnay && !status1) {
                alert('Вы не указали номер накладной');
                $("#nakladnaya").focus();
                return;
            }
            if (!nakladnay.match(/[0-9]{7}/) && !status1) {
                alert("В поле накладная должны быть введены только цифры");
                $("#nakladnaya").focus();
                return;
            }
            if(count<2 && !status1){
                alert('данные по накладной пусты'); $("#nameGruz").focus(); return;
            }
            let typeCar = $("[name='cheks']:checked").val();
            console.log(typeCar);
            if (typeCar == "1") {
                agent = $("#otpravitel").children("option:selected").val();
            } else {
                agent = $("#poluchatel").children("option:selected").val();
            }
            let obj = [];
            let c=0;
            Table.forEach(function (a, v) {
                obj[c]=[a.count,a.name,a.price,a.valuta,a.ves,a.ed];
                c++;
            });


            let data = {
                'ves': ves,
                'nakladnaya': nakladnay,
                'typeCar': typeCar,
                'numAuto': numAuto,
                'numPricep': numberPricep,
                'contragent': agent,
                "dataNakladnay":obj,
            };
console.log(data);
            $.ajax({
                type: "POST",
                url: '{% url 'addautoPOST' %}',
                traditional: true,
                dataType: 'json',
                data: data,
                success: function () {
                    console.log('Load was performed.');
                },
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

        }








var fieldO= $('#otpravitel').find('option');
// собственно поиск
$('#searchingOtpr').bind('keyup', function() {
    var q = new RegExp($(this).val(), 'ig'),
        bol = true;
if($('#searchingOtpr').val().length==0){
    $('#otpravitel').css('display','none');
}else{
    $('#otpravitel').css('display','block');
}
    for (var i = 0, l = fieldO.length; i < l; i += 1) {
        var option = $(fieldO[i]);
        if ($(fieldO[i]).text().match(q)) {
                option.show();
        } else {
            if (option.is('option') ) {
                option.hide() }
        } }
});


var fieldP= $('#poluchatel').find('option');
// собственно поиск
$('#searchingPol').bind('keyup', function() {
    var q = new RegExp($(this).val(), 'ig'),
        bol = true;
if($('#searchingPol').val().length==0){
    $('#otpravitel').css('display','none');
}else{
    $('#otpravitel').css('display','block');
}
    for (var i = 0, l = fieldP.length; i < l; i += 1) {
        var option = $(fieldP[i]);
        if ($(fieldP[i]).text().match(q)) {
                option.show();
        } else {
            if (option.is('option') ) {
                option.hide() }
        } }
});
let auto_in = "{{ JAuto }}";
auto_in = auto_in.replace(/&quot;/g,'"');
auto_in = JSON.parse(auto_in);
function getData(){
    var num = $('#gos_num_avto').html();
    if(status!="true"){
        auto_in.forEach(function (a) {
            console.log(a);
            if(a.fields.number==num.replace(/-/g,'')){
                 console.log(num.replace(/-/g,''));
                status1 = true;
                $("#DataNakladnaya").hide();
                $("#dataTransport").hide();
                return;
            }else{
                status1= false;
                $("#DataNakladnaya").show();
                 $("#dataTransport").show();
            }
        });
    }else{
        $("#DataNakladnaya").show();
        $("#dataTransport").show();
    }
    let data ={"zanyato":true,"all":false};
              $.ajax({
                type: "POST",
                url: '{% url 'getDataAuto' %}',
                traditional: true,
                dataType: 'json',
                data: data,
                success: function (dat) {
                    console.log(dat);
                },
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
}
getData();

setInterval(getData, 1000);







$(document).ready(function(){$("[data-bs-hover-animate]").mouseenter(function(){var a=$(this);a.addClass("animated "+a.attr("data-bs-hover-animate"))}).mouseleave(function(){var a=$(this);a.removeClass("animated "+a.attr("data-bs-hover-animate"))})});








    </script>


    <style>
        .hidden-menu {
            display: block;
            position: fixed;
            list-style: none;
            padding: 10px;
            margin: 0;

            box-sizing: border-box;
            width: 40%;
            background-color: #eee;
            height: 100%;
            top: 10%;
            left: -40%;
            transition: left .2s;
            z-index: 2;
            -webkit-transform: translateZ(0);
            -webkit-backface-visibility: hidden;
        }

        .hidden-menu-ticker {
            display: none;
        }

        .btn-menu {
            color: #fff;
            background-color: #0058B9;
            padding: 7px;
            position: fixed;
            top: 10%;
            left: 5px;
            cursor: pointer;
            transition: left .23s;
            z-index: 3;
            width: 60px;
            -webkit-transform: translateZ(0);
            -webkit-backface-visibility: hidden;
        }

        .btn-menu span {
            display: block;
            height: 3px;
            background-color: #fff;
            margin: 5px 0 0;
            transition: all .1s linear .23s;
            position: relative;
        }

        .btn-menu span.first {
            margin-top: 0;
        }

        .hidden-menu-ticker:checked ~ .btn-menu {
            left: 35%;
        }

        .hidden-menu-ticker:checked ~ .hidden-menu {
            left: 0;
        }

        .hidden-menu-ticker:checked ~ .btn-menu span.first {
            -webkit-transform: rotate(45deg);
            top: 8px;

        }

        .hidden-menu-ticker:checked ~ .btn-menu span.second {
            opacity: 0;
        }

        .hidden-menu-ticker:checked ~ .btn-menu span.third {
            -webkit-transform: rotate(-45deg);
            top: -8px;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            /* display: none; <- Crashes Chrome on hover */
            -webkit-appearance: none;
            margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
        }
    </style>












{% endblock %}